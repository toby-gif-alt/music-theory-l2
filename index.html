<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCEA L2 (AS91276) Question Generator</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1224; --panel2:#101a33; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;background:linear-gradient(180deg,#0b1224,#0f172a 30%,#0b1224 100%);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:.92rem}
    main{padding:20px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:340px 1fr}}
    .card{background:linear-gradient(180deg,#0b1224,#0f1830);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card .pad{padding:16px}
    .card h2{margin:0 0 8px;font-size:1.05rem}
    label{display:block;margin:10px 0 4px;color:#cbd5e1;font-size:.9rem}
    select,input,textarea,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1224;color:#e5e7eb}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btn{cursor:pointer;border:1px solid #334155;background:linear-gradient(180deg,#101a33,#0e162c);transition:transform .04s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 1px #334155,0 6px 16px rgba(0,0,0,.35)}
    .btn:active{transform:translateY(1px)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:.8rem}
    .tag{padding:2px 8px;border-radius:999px;background:#0b1224;border:1px solid #334155;color:#a5b4fc}
    .qbox{border-top:1px dashed #334155;margin-top:12px;padding-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Monospace}
    .answer{border-left:4px solid var(--acc);padding:8px 12px;background:#0b1224;border-radius:8px;margin-top:10px;white-space:pre-wrap}
    .muted{color:var(--muted)}
    .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .right{text-align:right}
    .small{font-size:.85rem}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .hl{color:#a5b4fc}
    .printable h3{margin:.6rem 0}
    .twin{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media print{header,.controls{display:none}body{background:#fff;color:#000}.card{border:none;box-shadow:none}.printable{page-break-before:always}}
    .kbd{font-family:ui-monospace,Monaco,Consolas;background:#0b1224;border:1px solid #334155;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>AS91276 Question Generator <span class="tag">v2</span></h1>
      <div class="sub">NZQA Level 2 Music – <em>Demonstrate knowledge of conventions in a range of music scores</em>. Single‑file app – host as <span class="kbd">index.html</span> on GitHub Pages.</div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT: controls -->
    <section class="card">
      <div class="pad">
        <h2>Build a pack</h2>
        <label>Topics (choose one or more)</label>
        <select id="topics" multiple size="8">
          <option value="qIntervals">Intervals (quality + quantity)</option>
          <option value="qTransposition">Transposition (Bb/Eb/F to concert & back)</option>
          <option value="qTexture">Texture & contrast (describe → analyse effect)</option>
          <option value="qTonality">Tonality (key + evidence, modulation)</option>
          <option value="qHarmony">Harmony (chord symbols, inversions)</option>
          <option value="qCadences">Cadences (ID + bass/7th logic – text)</option>
          <option value="qDevices">Compositional devices (define/apply)</option>
          <option value="qPerf">Performance markings & articulation</option>
        </select>

        <label>Difficulty mapping</label>
        <select id="difficulty">
          <option value="A">Achievement – identify / describe</option>
          <option value="M">Merit – explain / give evidence</option>
          <option value="E">Excellence – analyse / apply with effect</option>
        </select>

        <div class="row">
          <label>How many questions?</label>
          <input id="qty" type="number" min="1" max="50" value="10" />
        </div>

        <div class="row3">
          <button class="btn" id="gen">Generate</button>
          <button class="btn" id="clear">Clear</button>
          <button class="btn" id="print">Print / Save PDF</button>
        </div>

        <h2 style="margin-top:16px">Rubric helper</h2>
        <div class="small muted">
          <ul>
            <li><span class="hl">A</span> – identify / name / describe items correctly.</li>
            <li><span class="hl">M</span> – explain with specific <em>evidence</em> from the score (underlined‑type cues).</li>
            <li><span class="hl">E</span> – analyse/apply and discuss <em>effect on performance / sound</em> (bold‑type cues).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- RIGHT: output -->
    <section class="card">
      <div class="pad">
        <h2>Output</h2>
        <div id="out"></div>
        <div id="schedule"></div>
      </div>
    </section>
  </main>

  <script type="module">
// ===== Auto Loader: fetch mined data from /data produced by the Action =====
const [banks, patterns] = await Promise.all([
  fetch('data/banks.json').then(r=>r.json()),
  fetch('data/patterns.json').then(r=>r.json()).catch(()=>({stems:[], verbs:[], rubric:[]}))
]).catch(err=>{ console.error(err); return [{}, {stems:[],verbs:[],rubric:[]}]; });

// ===== Helpers =====
const pick = a => a[Math.floor(Math.random()*a.length)];
const cap = s => s.charAt(0).toUpperCase()+s.slice(1);
const DIFF = {
  A: s=>`Identify / describe: ${s}`,
  M: s=>`Explain with evidence from the score: ${s}`,
  E: s=>`Analyse/apply and discuss the effect on the music: ${s}`
};

// ===== Question Generators (browser) =====
function qIntervals(level){
  const items = Array.from({length:6},()=>`${pick(banks.intervalQualities)} ${pick(banks.intervalNumbers)}`);
  return {topic:'Intervals', stem:`${DIFF[level]('Identify the quality and quantity of the labelled intervals ①–⑥ (e.g., minor 3rd).')} Intervals may include: ${items.join(', ')}.`, model:`Quality + quantity on each; correct for clef.`};
}
function qTransposition(level){
  const fam = pick(Object.keys(banks.instruments));
  const inst = pick(banks.instruments[fam]);
  const dir = Math.random()<0.5?'to concert pitch':'to written pitch';
  const key = `${pick(banks.keys)} ${pick(banks.modes)}`;
  const ivl = fam==='Bb'? 'a major 2nd' : fam==='Eb'? 'a major 6th' : 'a perfect 5th';
  return {topic:'Transposition', stem:`${DIFF[level](`Transpose ${dir}: ${inst} part in ${key}. State the transposition interval and ${level==='A'?'direction': level==='M'?'resulting key and direction':'justify key‑signature change and accidentals'}.`)}`, model:`${inst} transposes by ${ivl}. Include correct key signature; keep performance markings.`};
}
function qTexture(level){
  return {topic:'Texture', stem:`${DIFF[level]('Discuss the texture using two specific pieces of evidence (bars/parts).')}`, model:`E.g., monophonic → homophonic; imitative entries; cite bars/parts.`};
}
function qTonality(level){
  const key = `${pick(banks.keys)} ${pick(banks.modes)}`;
  return {topic:'Tonality', stem:`${DIFF[level](`Identify the key (${key} implied) and provide ${level==='A'?'one':'two'} piece(s) of evidence${level==='E'?'; comment on brief modulation':''}.`)}`, model:`${key}. Evidence: key sig; V or V7→I; opening/closing chords.`};
}
function qHarmony(level){
  return {topic:'Harmony', stem:`${DIFF[level]('Add chord symbols (jazz/rock) for a 4‑bar phrase. Include one inversion.')}`, model:`Derive from bass + upper voices; include at least one inversion; cadential function.`};
}
function qCadences(level){
  const cad = pick(banks.cadenceTypes);
  return {topic:'Cadences', stem:`${DIFF[level](`Name the cadence (${cad} may occur)${level!=='A'?'; describe/notate bass (and 7th)':''}.`)}`, model:`${cad.split(' ')[0]} cadence; chord tones support label.`};
}
function qDevices(level){
  const [name,def] = pick(banks.devices);
  return {topic:'Devices', stem:`${DIFF[level](`Define "${name}"${level!=='A'?' and outline a 2–4 bar example':''}.`)}`, model:`${cap(name)} – ${def}.`};
}
function qPerf(level){
  const [name,why] = pick(banks.perf);
  return {topic:'Performance', stem:`${DIFF[level](`Explain how "${name}" would be played, with score evidence.`)}`, model:`${cap(name)} – ${why}.`};
}

const GEN = { qIntervals, qTransposition, qTexture, qTonality, qHarmony, qCadences, qDevices, qPerf };
const TOPIC_KEYS = Object.keys(GEN);

// ===== Evidence/Rubric builder for Assessment Schedule =====
function scheduleFor(topic){
  // Light, generic schedule aligned to A/M/E; we enrich with any mined verbs to sound authentic.
  const extra = (patterns.verbs?.length? pick(patterns.verbs).replace(/\s+/g,' ').slice(0,120) : '');
  const base = {
    A: 'Identifies / describes correctly.',
    M: 'Explains using specific musical evidence (bars/parts/notations).',
    E: 'Analyses and states the effect on performance/sound; coherent justification.'
  };
  const special = {
    qIntervals: {
      A:'Names quality/quantity of most intervals.',
      M:'Names all intervals with workings (semitone count / context).',
      E:'Relates dissonance/resolution to musical effect.'
    },
    qTransposition: {
      A:'States correct direction/interval.',
      M:'Gives resulting key & direction with correct key signature.',
      E:'Justifies signature/accidentals and performance/tessitura impact.'
    },
    qTonality: {
      A:'Names plausible key.',
      M:'Gives two pieces of evidence (cadence/chords/accidentals).',
      E:'Comments on brief modulation or tonicisation with chord evidence.'
    },
    qHarmony: {
      A:'Provides mostly correct chord symbols.',
      M:'Includes inversion(s) and cadential point.',
      E:'Explains harmonic function (T/S/D) and any secondary dominant.'
    },
    qCadences: {
      A:'Labels cadence type correctly.',
      M:'Supplies bass/7th as appropriate.',
      E:'Explains closure/continuation effect and voice‑leading.'
    },
    qTexture: {
      A:'Identifies texture(s).',
      M:'Explains with two pieces of score evidence.',
      E:'Links texture to musical character/effect.'
    },
    qDevices: {
      A:'Defines device.',
      M:'Outlines a valid short example.',
      E:'Explains the device's impact on expectation/momentum.'
    },
    qPerf: {
      A:'Identifies marking(s).',
      M:'Explains how to play them with evidence.',
      E:'Analyses effect on listener/ensemble balance.'
    }
  };
  const sp = special[topic]||{};
  return {
    A: sp.A || base.A,
    M: sp.M || base.M,
    E: sp.E || base.E,
    flavour: extra
  };
}

// ===== Renderers =====
function el(id){ return document.getElementById(id); }
function renderExam(qs){
  const out = el('out');
  out.innerHTML = '';
  qs.forEach((q,i)=>{
    const div = document.createElement('div');
    div.className = 'qbox';
    div.innerHTML = `<h3>Q${i+1} [${q.topic}]</h3><div class="mono">${q.stem}</div>`;
    out.appendChild(div);
  });
}
function renderSchedule(qs){
  const sched = el('schedule');
  sched.innerHTML='';
  const wrap = document.createElement('div');
  wrap.innerHTML = `<h2>Assessment Schedule</h2>`;
  qs.forEach((q,i)=>{
    const s = scheduleFor(q._key);
    const sec = document.createElement('div');
    sec.className='qbox';
    sec.innerHTML = `
      <h3>Q${i+1} [${q.topic}]</h3>
      <div class="small"><em>Authenticity flavour:</em> ${s.flavour||'—'}</div>
      <ul>
        <li><strong>Achievement:</strong> ${s.A}</li>
        <li><strong>Merit:</strong> ${s.M}</li>
        <li><strong>Excellence:</strong> ${s.E}</li>
      </ul>`;
    sched.appendChild(sec);
  });
}

// ===== Main button wiring =====
function buildPack(){
  const topicsSel = el('topics');
  const chosen = topicsSel ? Array.from(topicsSel.selectedOptions).map(o=>o.value) : [];
  const keys = chosen.length ? chosen : TOPIC_KEYS;
  const level = (el('difficulty')?.value || 'A').toUpperCase();
  const n = Math.min(Math.max(parseInt(el('qty')?.value)||10,1),50);
  const qs = [];
  for(let i=0;i<n;i++){
    const k = pick(keys);
    const fn = GEN[k];
    const q = fn(level);
    q._key = k;
    qs.push(q);
  }
  renderExam(qs);
  renderSchedule(qs);
  window._lastQs = qs;
}

el('gen')?.addEventListener('click', buildPack);
el('clear')?.addEventListener('click', ()=>{ el('out').innerHTML=''; el('schedule').innerHTML=''; window._lastQs=null; });
el('print')?.addEventListener('click', ()=>window.print());

// Auto-generate one pack on load for instant UX
buildPack();
</script>

<!-- Tip: ensure you have containers with ids: out, schedule, and the controls (gen/clear/print, qty, topics, difficulty). Remove any "paste" UI. -->
</body>
</html>
