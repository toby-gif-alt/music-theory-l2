<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCEA L2 (AS91276) Question Generator</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1224; --panel2:#101a33; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;background:linear-gradient(180deg,#0b1224,#0f172a 30%,#0b1224 100%);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:.92rem}
    main{padding:20px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:340px 1fr}}
    .card{background:linear-gradient(180deg,#0b1224,#0f1830);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card .pad{padding:16px}
    .card h2{margin:0 0 8px;font-size:1.05rem}
    label{display:block;margin:10px 0 4px;color:#cbd5e1;font-size:.9rem}
    select,input,textarea,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1224;color:#e5e7eb}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btn{cursor:pointer;border:1px solid #334155;background:linear-gradient(180deg,#101a33,#0e162c);transition:transform .04s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 1px #334155,0 6px 16px rgba(0,0,0,.35)}
    .btn:active{transform:translateY(1px)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:.8rem}
    .tag{padding:2px 8px;border-radius:999px;background:#0b1224;border:1px solid #334155;color:#a5b4fc}
    .qbox{border-top:1px dashed #334155;margin-top:12px;padding-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Monospace}
    .answer{border-left:4px solid var(--acc);padding:8px 12px;background:#0b1224;border-radius:8px;margin-top:10px;white-space:pre-wrap}
    .muted{color:var(--muted)}
    .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .right{text-align:right}
    .small{font-size:.85rem}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .hl{color:#a5b4fc}
    .printable h3{margin:.6rem 0}
    .twin{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media print{header,.controls{display:none}body{background:#fff;color:#000}.card{border:none;box-shadow:none}.printable{page-break-before:always}}
    .kbd{font-family:ui-monospace,Monaco,Consolas;background:#0b1224;border:1px solid #334155;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>AS91276 Question Generator <span class="tag">v2</span></h1>
      <div class="sub">NZQA Level 2 Music – <em>Demonstrate knowledge of conventions in a range of music scores</em>. Single‑file app – host as <span class="kbd">index.html</span> on GitHub Pages.</div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT: controls -->
    <section class="card">
      <div class="pad">
        <h2>Build a pack</h2>
        <label>Topics (choose one or more)</label>
        <select id="topics" multiple size="7">
          <option value="qIntervals">Intervals (quality + quantity)</option>
          <option value="qTransposition">Transposition (Bb/Eb/F to concert & back)</option>
          <option value="qTonality">Tonality (key + evidence, modulation)</option>
          <option value="qHarmony">Harmony (chord symbols, inversions)</option>
          <option value="qCadences">Cadences (ID + bass/7th logic – text)</option>
          <option value="qDevices">Compositional devices (define/apply)</option>
          <option value="qPerf">Performance markings & articulation</option>
        </select>

        <label>Difficulty mapping</label>
        <select id="difficulty">
          <option value="A">Achievement – identify / describe</option>
          <option value="M">Merit – explain / give evidence</option>
          <option value="E">Excellence – analyse / apply with effect</option>
        </select>

        <div class="row">
          <label>How many questions?</label>
          <input id="qty" type="number" min="1" max="50" value="10" />
        </div>

        <div class="row3">
          <button class="btn" id="gen">Generate</button>
          <button class="btn" id="clear">Clear</button>
          <button class="btn" id="print">Print / Save PDF</button>
        </div>

        <h2 style="margin-top:16px">Rubric helper</h2>
        <div class="small muted">
          <ul>
            <li><span class="hl">A</span> – identify / name / describe items correctly.</li>
            <li><span class="hl">M</span> – explain with specific <em>evidence</em> from the score (underlined‑type cues).</li>
            <li><span class="hl">E</span> – analyse/apply and discuss <em>effect on performance / sound</em> (bold‑type cues).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- RIGHT: output -->
    <section class="card">
      <div class="pad">
        <h2>Output</h2>
        <div id="out"></div>
        <div id="schedule"></div>
      </div>
    </section>
  </main>

<script src="https://unpkg.com/vexflow/releases/vexflow-debug.js"></script>
  
  <script type="module">
// ===== Auto Loader: fetch mined data from /data produced by the Action =====
const [banks, patterns] = await Promise.all([
  fetch('data/banks.json').then(r=>r.json()),
  fetch('data/patterns.json').then(r=>r.json()).catch(()=>({stems:[], verbs:[], rubric:[]}))
]).catch(err=>{ console.error(err); return [{}, {stems:[],verbs:[],rubric:[]}]; });

// ===== Load VexFlow (from window if script tag present) =====
let VF = window.Vex && window.Vex.Flow;
if(!VF){
  try {
    // Fallback: dynamic import from CDN (works on Pages). If you self-host, remove this.
    await import('https://unpkg.com/vexflow/releases/vexflow-debug.js');
    VF = window.Vex.Flow;
  } catch(e) {
    console.warn('VexFlow not available, notation rendering disabled:', e.message);
  }
}

// ===== Helpers =====
const pick = a => a[Math.floor(Math.random()*a.length)];
const cap = s => s.charAt(0).toUpperCase()+s.slice(1);
const DIFF = {
  A: s=>`Identify / describe: ${s}`,
  M: s=>`Explain with evidence from the score: ${s}`,
  E: s=>`Analyse/apply and discuss the effect on the music: ${s}`
};

// ===== Notation helpers (VexFlow) =====
const NOTE_NAMES = ['c','d','e','f','g','a','b'];
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function randNoteInRange(clef){
  // Rough ranges per clef
  if(clef==='bass') return {key: `${pick(['c','d','e','f','g','a','b'])}/${randInt(2,4)}`, acc: null};
  return {key: `${pick(['c','d','e','f','g','a','b'])}/${randInt(4,5)}`, acc: null};
}
function semitoneOffset(note, semi){
  // Convert like 'c/4' to midi-ish number, offset, and back (simple diatonic + sharps only for demo)
  const [n,octStr] = note.split('/');
  const base = {c:0,d:2,e:4,f:5,g:7,a:9,b:11}[n[0]] + 12*parseInt(octStr);
  const midi = base + semi;
  const oct = Math.floor(midi/12);
  const pc = midi%12;
  const name = Object.entries({c:0, 'c#':1, d:2, 'd#':3, e:4, f:5,'f#':6, g:7,'g#':8, a:9,'a#':10, b:11}).find(([,v])=>v===pc)[0];
  const acc = name.includes('#')?'#':null; const letter = name.replace('#','');
  return { key: `${letter}/${oct}`, acc };
}
function vfFactory(el, {width=540, height=160}={}){
  if(!VF) return null;
  const f = new VF.Factory({renderer:{elementId: el, width, height}});
  return f;
}
function drawSystem(f, {clef='treble', keySig='C', timeSig='4/4'}={}){
  if(!f) return {score:null, system:null, stave:null};
  const score = f.EasyScore();
  const system = f.System();
  const stave = system.addStave({ voices: [] });
  stave.addClef(clef).addKeySignature(keySig).addTimeSignature(timeSig);
  return {score, system, stave};
}

// ===== Engraved question builders =====
function engraveIntervals(elId, level){
  if(!VF) return;
  const f = vfFactory(elId);
  if(!f) return;
  const {score, system, stave} = drawSystem(f, {clef:'treble', keySig: pick(banks.keys), timeSig:'4/4'});
  const notes = [];
  const labels = [];
  for(let i=1;i<=6;i++){
    const base = randNoteInRange('treble');
    const quality = pick(banks.intervalQualities);
    const number = pick(banks.intervalNumbers);
    // Map common intervals to semitone offsets (simplified)
    const mapQ = { '2nd':2, '3rd':4, '4th':5, '5th':7, '6th':9, '7th':11, 'octave':12 };
    const sign = Math.random()<0.5? -1: 1;
    const semiBase = mapQ[number] || 7; // default perfect 5th
    const adjust = quality==='minor'? -1 : quality==='augmented'? +1 : quality==='diminished'? -1 : 0;
    const semi = sign*(semiBase + adjust);
    const other = semitoneOffset(base.key, semi);
    const na = new VF.StaveNote({ keys:[base.key], duration:'8', clef:'treble' });
    if(base.acc) na.addAccidental(0, new VF.Accidental(base.acc));
    const nb = new VF.StaveNote({ keys:[other.key], duration:'8', clef:'treble' });
    if(other.acc) nb.addAccidental(0, new VF.Accidental(other.acc));
    // add small number label above second note
    nb.addModifier(0, (new VF.Annotation(String(i))).setFont('Arial', 10).setJustification(VF.Annotation.Justify.CENTER).setVerticalJustification(VF.Annotation.VerticalJustify.TOP));
    notes.push(na, nb);
  }
  const voice = f.EasyScore().voice(notes, {time:'12/4'});
  f.System().addStave({voices:[voice]});
  f.draw();
}

function engraveTransposition(elId, level){
  if(!VF) return;
  const key = pick(banks.keys);
  const clef = 'treble';
  const f = vfFactory(elId);
  if(!f) return;
  const {score, system, stave} = drawSystem(f, {clef, keySig:key, timeSig:'4/4'});
  // Build a simple 1-bar melody
  const pitches = ['c/4','d/4','e/4','g/4','a/4','b/4','c/5'];
  const seq = Array.from({length:8}, ()=> pick(pitches));
  const vfNotes = seq.map(k=> new VF.StaveNote({ keys:[k], duration:'8', clef }));
  const voice = score.voice(vfNotes, {time:'4/4'});
  system.addStave({voices:[voice]});
  f.draw();
}

function engraveTonality(elId, level){
  if(!VF) return;
  const key = pick(banks.keys);
  const clef = 'treble';
  const f = vfFactory(elId, {width:640, height:170});
  if(!f) return;
  const {score, system} = drawSystem(f, {clef, keySig:key, timeSig:'4/4'});
  // Two bars: bar1 stepwise, bar2 small skips, implies V–I near end
  const bar1 = ['c/4','d/4','e/4','f/4','g/4','a/4','b/4','c/5'];
  const bar2 = ['e/5','d/5','c/5','b/4','a/4','g/4','f/4','e/4'];
  const seq = bar1.map(p=> new VF.StaveNote({keys:[p], duration:'8', clef}))
             .concat(bar2.map(p=> new VF.StaveNote({keys:[p], duration:'8', clef})));
  const voice = score.voice(seq, {time:'8/4'});
  system.addStave({voices:[voice]});
  f.draw();
}

// ===== Text-only generators (kept for non-engraved topics) =====
function qIntervals(level){
  return {topic:'Intervals', stem:`${DIFF[level]('Identify the quality and quantity of the labelled intervals ①–⑥ (e.g., minor 3rd).')}`, model:`Quality + quantity on each; correct for clef.`, render:(id)=>engraveIntervals(id, level)};
}
function qTransposition(level){
  const fam = pick(Object.keys(banks.instruments));
  const inst = pick(banks.instruments[fam]);
  const dir = Math.random()<0.5?'to concert pitch':'to written pitch';
  return {topic:'Transposition', stem:`${DIFF[level](`Transpose ${dir}: ${inst}. State the transposition interval and ${level==='A'?'direction': level==='M'?'resulting key and direction':'justify key‑signature change and accidentals'}.`)}`, model:`${inst} transposes (Bb M2, Eb M6, F P5).`, render:(id)=>engraveTransposition(id, level)};
}
function qTonality(level){
  return {topic:'Tonality', stem:`${DIFF[level]('Identify the key and provide evidence (cadence/chord tones).')}`, model:`Key signature; V or V7→I; opening/closing tones.`, render:(id)=>engraveTonality(id, level)};
}

function qHarmony(level){
  return {topic:'Harmony', stem:`${DIFF[level]('Add chord symbols for a 4‑bar phrase. Include one inversion.')}`, model:`Derive from bass + melody; mark cadential point.`};
}
function qCadences(level){
  const cad = pick(banks.cadenceTypes);
  return {topic:'Cadences', stem:`${DIFF[level](`Name the cadence (${cad} may occur).`)}`, model:`${cad.split(' ')[0]} cadence; chord tones support label.`};
}
function qDevices(level){
  const [name,def] = pick(banks.devices);
  return {topic:'Devices', stem:`${DIFF[level](`Define "${name}"${level!=='A'?' and outline a 2–4 bar example':''}.`)}`, model:`${cap(name)} – ${def}.`};
}
function qPerf(level){
  const [name,why] = pick(banks.perf);
  return {topic:'Performance', stem:`${DIFF[level](`Explain how "${name}" would be played, with score evidence.`)}`, model:`${cap(name)} – ${why}.`};
}

const GEN = { qIntervals, qTransposition, qTonality, qHarmony, qCadences, qDevices, qPerf };
const TOPIC_KEYS = Object.keys(GEN);

// ===== Assessment Schedule builder =====
function scheduleFor(key){
  const base = {
    A: 'Identifies / describes correctly.',
    M: 'Explains using specific musical evidence (bars/parts/notations).',
    E: 'Analyses and states the effect on performance/sound; coherent justification.'
  };
  const special = {
    qIntervals:{A:'Names quality/quantity of most intervals.', M:'All intervals with workings.', E:'Links dissonance/resolution to effect.'},
    qTransposition:{A:'Correct direction & interval.', M:'Resulting key & signature correct.', E:'Justifies signature/accidentals & tessitura impact.'},
    qTonality:{A:'Names plausible key.', M:'Two pieces of evidence (cadence/chords/accidentals).', E:'Notes brief modulation/tonicisation with chord evidence.'}
  };
  const sp = special[key]||{}; return { A:sp.A||base.A, M:sp.M||base.M, E:sp.E||base.E };
}

// ===== Renderers =====
function el(id){ return document.getElementById(id); }
function renderExam(qs){
  const out = el('out'); out.innerHTML='';
  qs.forEach((q,i)=>{
    const div = document.createElement('div'); div.className='qbox';
    const vfId = `vf-${i+1}`;
    div.innerHTML = `<h3>Q${i+1} [${q.topic}]</h3><div class="mono">${q.stem}</div><div id="${vfId}"></div>`;
    out.appendChild(div);
    if(q.render) {
      try {
        q.render(vfId);
      } catch(e) {
        console.warn('Failed to render notation for Q'+(i+1), e);
      }
    }
  });
}
function renderSchedule(qs){
  const sched = el('schedule'); sched.innerHTML='';
  const wrap = document.createElement('div'); wrap.innerHTML = `<h2>Assessment Schedule</h2>`;
  sched.appendChild(wrap);
  qs.forEach((q,i)=>{
    const s = scheduleFor(q._key);
    const sec = document.createElement('div'); sec.className='qbox';
    sec.innerHTML = `<h3>Q${i+1} [${q.topic}]</h3><ul><li><strong>Achievement:</strong> ${s.A}</li><li><strong>Merit:</strong> ${s.M}</li><li><strong>Excellence:</strong> ${s.E}</li></ul>`;
    sched.appendChild(sec);
  });
}

// ===== Main wiring =====
function buildPack(){
  const topicsSel = el('topics');
  const chosen = topicsSel ? Array.from(topicsSel.selectedOptions).map(o=>o.value) : [];
  const keys = chosen.length ? chosen : TOPIC_KEYS;
  const level = (el('difficulty')?.value || 'A').toUpperCase();
  const n = Math.min(Math.max(parseInt(el('qty')?.value)||8,1),30);
  const qs = [];
  for(let i=0;i<n;i++){
    const k = pick(keys);
    const fn = GEN[k];
    const q = fn(level); q._key = k; qs.push(q);
  }
  renderExam(qs); renderSchedule(qs); window._lastQs = qs;
}

el('gen')?.addEventListener('click', buildPack);
el('clear')?.addEventListener('click', ()=>{ el('out').innerHTML=''; el('schedule').innerHTML=''; window._lastQs=null; });
el('print')?.addEventListener('click', ()=>window.print());

// Auto-generate one pack on load
buildPack();
</script>

<!-- Tip: ensure you have containers with ids: out, schedule, and the controls (gen/clear/print, qty, topics, difficulty). Remove any "paste" UI. -->
</body>
</html>
