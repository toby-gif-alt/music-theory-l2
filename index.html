<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCEA L2 (AS91276) Question Generator</title>
  <!-- Load a UMD build of VexFlow (window.Vex.Flow available after load). -->
  <script src="https://unpkg.com/vexflow@3.0.9/build/cjs/vexflow-debug.js" defer></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1224; --panel2:#101a33; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;background:linear-gradient(180deg,#0b1224,#0f172a 30%,#0b1224 100%);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:.92rem}
    main{padding:20px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:340px 1fr}}
    .card{background:linear-gradient(180deg,#0b1224,#0f1830);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card .pad{padding:16px}
    .card h2{margin:0 0 8px;font-size:1.05rem}
    label{display:block;margin:10px 0 4px;color:#cbd5e1;font-size:.9rem}
    select,input,textarea,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1224;color:#e5e7eb}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btn{cursor:pointer;border:1px solid #334155;background:linear-gradient(180deg,#101a33,#0e162c);transition:transform .04s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 1px #334155,0 6px 16px rgba(0,0,0,.35)}
    .btn:active{transform:translateY(1px)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:.8rem}
    .tag{padding:2px 8px;border-radius:999px;background:#0b1224;border:1px solid #334155;color:#a5b4fc}
    .qbox{border-top:1px dashed #334155;margin-top:12px;padding-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Monospace}
    .answer{border-left:4px solid var(--acc);padding:8px 12px;background:#0b1224;border-radius:8px;margin-top:10px;white-space:pre-wrap}
    .muted{color:var(--muted)}
    .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .right{text-align:right}
    .small{font-size:.85rem}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .hl{color:#a5b4fc}
    .printable h3{margin:.6rem 0}
    .twin{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media print{header,.controls{display:none}body{background:#fff;color:#000}.card{border:none;box-shadow:none}.printable{page-break-before:always}}
    .kbd{font-family:ui-monospace,Monaco,Consolas;background:#0b1224;border:1px solid #334155;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>AS91276 Question Generator <span class="tag">v2</span></h1>
      <div class="sub">NZQA Level 2 Music – <em>Demonstrate knowledge of conventions in a range of music scores</em>. Single‑file app – host as <span class="kbd">index.html</span> on GitHub Pages.</div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT: controls -->
    <section class="card">
      <div class="pad">
        <h2>Build a pack</h2>
        <label>Topics (choose one or more)</label>
        <select id="topics" multiple size="5">
          <option value="qIntervals">Intervals (quality + quantity)</option>
          <option value="qTransposition">Transposition (Bb/Eb/F to concert & back)</option>
          <option value="qTonality">Tonality (key + evidence, modulation)</option>
          <option value="qHarmony">Harmony (chord symbols, inversions)</option>
          <option value="qCadences">Cadences (ID + bass/7th logic – text)</option>
        </select>

        <label>Difficulty mapping</label>
        <select id="difficulty">
          <option value="A">Achievement – identify / describe</option>
          <option value="M">Merit – explain / give evidence</option>
          <option value="E">Excellence – analyse / apply with effect</option>
        </select>

        <div class="row">
          <label>How many questions?</label>
          <input id="qty" type="number" min="1" max="50" value="10" />
        </div>

        <div class="row3">
          <button class="btn" id="gen">Generate</button>
          <button class="btn" id="clear">Clear</button>
          <button class="btn" id="print">Print / Save PDF</button>
        </div>

        <h2 style="margin-top:16px">Rubric helper</h2>
        <div class="small muted">
          <ul>
            <li><span class="hl">A</span> – identify / name / describe items correctly.</li>
            <li><span class="hl">M</span> – explain with specific <em>evidence</em> from the score (underlined‑type cues).</li>
            <li><span class="hl">E</span> – analyse/apply and discuss <em>effect on performance / sound</em> (bold‑type cues).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- RIGHT: output -->
    <section class="card">
      <div class="pad">
        <h2>Output</h2>
        <div id="out"></div>
        <div id="schedule"></div>
      </div>
    </section>
  </main>

  <script type="module">
document.addEventListener('DOMContentLoaded', async () => {
  // --- Ensure VexFlow is present ---
  const VF = (window.Vex && window.Vex.Flow);
  if (!VF) {
    console.error('VexFlow not loaded. Check the <script src> in <head>.');
    alert('VexFlow failed to load. Refresh, or self-host vendor/vexflow-debug.js.');
    return;
  }

  // --- Load mined data ---
  const fetchJSON = (url, fallback) => fetch(url).then(r => r.ok ? r.json() : fallback).catch(() => fallback);
  const banks = await fetchJSON('data/banks.json', {
    intervalQualities: ["minor","major","perfect","diminished","augmented"],
    intervalNumbers: ["2nd","3rd","4th","5th","6th","7th","octave"],
    keys: ["C","G","D","A","E","B","F#","F","Bb","Eb","Ab","Db"],
    modes: ["major","minor"],
    cadenceTypes: ["perfect (V-I)","plagal (IV-I)","imperfect (any-V)","interrupted (V-vi)"],
    devices: [["sequence","repeat motif higher/lower"],["ostinato","repeated motif"],["inversion","intervals inverted"],["augmentation","note values longer"],["diminution","note values shorter"]],
    perf: [["staccato","short, detached"],["tenuto","slightly longer"],["marcato","accented"],["accent","emphasised"],["legato","smooth, connected"]],
    instruments: { Bb:["Clarinet in Bb","Trumpet in Bb"], Eb:["Alto Sax in Eb","Baritone Sax in Eb"], F:["Horn in F"] }
  });
  const patterns = await fetchJSON('data/patterns.json', { stems:[], verbs:[], rubric:[] });

  // --- Helpers (ASCII only) ---
  const pick = a => a[Math.floor(Math.random() * a.length)];
  const cap  = s => s.charAt(0).toUpperCase() + s.slice(1);
  const el   = id => document.getElementById(id);
  const DIFF = {
    A: s => "Identify / describe: " + s,
    M: s => "Explain with evidence from the score: " + s,
    E: s => "Analyse/apply and discuss the effect on the music: " + s
  };

  // --- VexFlow helpers ---
  function vfFactory(containerId, size) {
    const width  = (size && size.width)  || 560;
    const height = (size && size.height) || 160;
    return new VF.Factory({ renderer: { elementId: containerId, width, height }});
  }
  function drawSystem(factory, opts) {
    const clef   = (opts && opts.clef)   || "treble";
    const keySig = (opts && opts.keySig) || "C";
    const timeSig= (opts && opts.timeSig)|| "4/4";
    const score  = factory.EasyScore();
    const system = factory.System();
    const stave  = system.addStave({ voices: [] });
    stave.addClef(clef).addKeySignature(keySig).addTimeSignature(timeSig);
    return { score, system, stave };
  }
  function randInt(a, b){ return Math.floor(Math.random() * (b - a + 1)) + a; }
  function randNoteTreble(){ return pick(["c","d","e","f","g","a","b"]) + "/" + randInt(4,5); }
  function semitoneOffset(note, semi){
    const parts = note.split("/");
    const letter = parts[0], oct = parseInt(parts[1], 10);
    const pcMap = {c:0,d:2,e:4,f:5,g:7,a:9,b:11};
    const base  = pcMap[letter] + 12*oct;
    const midi  = base + semi;
    const outOct = Math.floor(midi/12);
    const pcs = {c:0,"c#":1,d:2,"d#":3,e:4,f:5,"f#":6,g:7,"g#":8,a:9,"a#":10,b:11};
    let outName = "c";
    for (const k in pcs){ if (pcs[k] === (midi % 12 + 12) % 12) { outName = k; break; } }
    const acc = outName.indexOf("#") >= 0 ? "#" : null;
    const baseLetter = outName.replace("#",""); 
    return { key: baseLetter + "/" + outOct, acc };
  }

  // --- Engraving builders (no nested backticks) ---
  function engraveIntervals(containerId){
    const factory = vfFactory(containerId);
    const keySig = pick(banks.keys || ["C"]);
    const res = drawSystem(factory, {clef:"treble", keySig:keySig, timeSig:"4/4"});
    const score = res.score, system = res.system;

    const q = banks.intervalQualities || ["minor","major","perfect","diminished","augmented"];
    const n = banks.intervalNumbers  || ["2nd","3rd","4th","5th","6th","7th","octave"];
    const semis = {"2nd":2,"3rd":4,"4th":5,"5th":7,"6th":9,"7th":11,"octave":12};

    const notes = [];
    for (let i = 1; i <= 6; i++){
      const a = randNoteTreble();
      const quality = pick(q);
      const number  = pick(n);
      const step    = semis[number] || 7;
      const adjust  = (quality === "minor") ? -1 : (quality === "augmented") ? 1 : (quality === "diminished") ? -1 : 0;
      const semi    = (Math.random() < 0.5 ? -1 : 1) * (step + adjust);
      const to      = semitoneOffset(a, semi);

      const na = new VF.StaveNote({ keys:[a],         duration:"8", clef:"treble" });
      const nb = new VF.StaveNote({ keys:[to.key],    duration:"8", clef:"treble" });
      if (to.acc) nb.addAccidental(0, new VF.Accidental(to.acc));
      nb.addModifier(0, (new VF.Annotation(String(i))).setFont("Arial", 10)
         .setJustification(VF.Annotation.Justify.CENTER)
         .setVerticalJustification(VF.Annotation.VerticalJustify.TOP));
      notes.push(na, nb);
    }
    const voice = score.voice(notes, {time:"12/4"});
    system.addStave({ voices:[voice] });
    factory.draw();
  }

  function engraveTransposition(containerId){
    const factory = vfFactory(containerId);
    const keySig = pick(banks.keys || ["C"]);
    const res = drawSystem(factory, {clef:"treble", keySig:keySig, timeSig:"4/4"});
    const score = res.score, system = res.system;
    const pool = ["c/4","d/4","e/4","f/4","g/4","a/4","b/4","c/5"];
    const seq = Array.from({length:8}, () => pick(pool))
      .map(k => new VF.StaveNote({ keys:[k], duration:"8", clef:"treble" }));
    const voice = score.voice(seq, {time:"4/4"});
    system.addStave({ voices:[voice] });
    factory.draw();
  }

  function engraveTonality(containerId){
    const factory = vfFactory(containerId, {width:640, height:170});
    const keySig = pick(banks.keys || ["C"]);
    const res = drawSystem(factory, {clef:"treble", keySig:keySig, timeSig:"4/4"});
    const score = res.score, system = res.system;
    const bar1 = ["c/4","d/4","e/4","f/4","g/4","a/4","b/4","c/5"];
    const bar2 = ["e/5","d/5","c/5","b/4","a/4","g/4","f/4","e/4"];
    const seq = bar1.concat(bar2).map(k => new VF.StaveNote({ keys:[k], duration:"8", clef:"treble" }));
    const voice = score.voice(seq, {time:"8/4"});
    system.addStave({ voices:[voice] });
    factory.draw();
  }

  // --- Question objects (ASCII only) ---
  const GEN = {
    qIntervals: function(level){
      const stem = DIFF[level]("Identify the quality and quantity of the labelled intervals 1 to 6.");
      return { topic:"Intervals", stem:stem, model:"Quality + quantity on each; correct for clef.", render: engraveIntervals };
    },
    qTransposition: function(level){
      const fams = Object.keys(banks.instruments || {Bb:[],Eb:[],F:[]});
      const fam  = fams.length ? pick(fams) : "Bb";
      const insts= (banks.instruments && banks.instruments[fam]) || ["Clarinet in Bb"];
      const inst = pick(insts);
      const base = "Transpose to concert pitch: " + inst + ". ";
      const addA = "State the interval and direction.";
      const addM = "State the interval, resulting key, and direction.";
      const addE = "Justify key-signature changes and accidentals.";
      const tail = (level === "A") ? addA : (level === "M") ? addM : addE;
      const stem = DIFF[level](base + tail);
      return { topic:"Transposition", stem:stem, model:"Bb=M2, Eb=M6, F=P5 families.", render: engraveTransposition };
    },
    qTonality: function(level){
      const base = "Identify the key and give evidence (for example, V or V7 to I near cadence).";
      const stem = DIFF[level](base);
      return { topic:"Tonality", stem:stem, model:"Evidence: key signature; V or V7->I; opening/closing chords.", render: engraveTonality };
    },
    qHarmony: function(level){
      const stem = DIFF[level]("Add chord symbols for a 4 bar phrase. Include one inversion.");
      return { topic:"Harmony", stem:stem, model:"Derive from bass and melody; include inversion; cadential function." };
    },
    qCadences: function(level){
      const cad = pick(banks.cadenceTypes || ["perfect (V-I)","plagal (IV-I)","imperfect (any-V)","interrupted (V-vi)"]);
      const stem = DIFF[level]("Name the cadence (for example: " + cad + ").");
      return { topic:"Cadences", stem:stem, model: cad.split(" ")[0] + " cadence; chord tones support label." };
    }
  };
  const TOPIC_KEYS = Object.keys(GEN);

  // --- Schedule text ---
  function scheduleFor(key){
    const base = {
      A: "Identifies or describes correctly.",
      M: "Explains using specific evidence (bars, parts, notation).",
      E: "Analyses and states the effect on performance or sound."
    };
    const special = {
      qIntervals:   { A:"Names quality and quantity for most intervals.", M:"All intervals with workings.", E:"Links dissonance or resolution to effect." },
      qTransposition:{A:"Correct direction and interval.", M:"Resulting key and signature correct.", E:"Justifies signature/accidentals and tessitura impact."},
      qTonality:    { A:"Names plausible key.", M:"Two pieces of evidence (cadence/chords/accidentals).", E:"Notes brief modulation or tonicisation with chord evidence." }
    };
    const sp = special[key] || {};
    return { A: sp.A || base.A, M: sp.M || base.M, E: sp.E || base.E };
  }

  // --- Renderers ---
  function renderExam(qs){
    const out = el('out'); if (!out) return;
    out.innerHTML = "";
    qs.forEach((q,i) => {
      const div = document.createElement('div');
      const vfId = "vf-" + (i+1);
      div.className = "qbox";
      div.innerHTML = "<h3>Q" + (i+1) + " [" + q.topic + "]</h3>"
                    + "<div class=\"mono\">" + q.stem + "</div>"
                    + "<div id=\"" + vfId + "\"></div>";
      out.appendChild(div);
      if (q.render) q.render(vfId);
    });
  }
  function renderSchedule(qs){
    const sc = el('schedule'); if (!sc) return;
    sc.innerHTML = "<h2>Assessment Schedule</h2>";
    qs.forEach((q,i) => {
      const s = scheduleFor(q._key);
      const sec = document.createElement('div');
      sec.className = "qbox";
      sec.innerHTML = "<h3>Q" + (i+1) + " [" + q.topic + "]</h3>"
                    + "<ul>"
                    + "<li><strong>Achievement:</strong> " + s.A + "</li>"
                    + "<li><strong>Merit:</strong> " + s.M + "</li>"
                    + "<li><strong>Excellence:</strong> " + s.E + "</li>"
                    + "</ul>";
      sc.appendChild(sec);
    });
  }

  // --- Main ---
  function buildPack(){
    const topicsSel = el('topics');
    const chosen = topicsSel ? Array.from(topicsSel.selectedOptions).map(o => o.value) : [];
    const keys = chosen.length ? chosen : TOPIC_KEYS;
    const level = (el('difficulty') && el('difficulty').value || "A").toUpperCase();
    const qtyEl = el('qty');
    const n = Math.min(Math.max(parseInt(qtyEl && qtyEl.value, 10) || 8, 1), 30);
    const qs = [];
    for (let i = 0; i < n; i++){
      const k = pick(keys);
      const q = GEN[k](level);
      q._key = k;
      qs.push(q);
    }
    renderExam(qs);
    renderSchedule(qs);
    window._lastQs = qs;
  }

  const btnGen = el('gen'), btnClear = el('clear'), btnPrint = el('print');
  if (btnGen)   btnGen.addEventListener('click', buildPack);
  if (btnClear) btnClear.addEventListener('click', () => { if (el('out')) el('out').innerHTML = ""; if (el('schedule')) el('schedule').innerHTML = ""; });
  if (btnPrint) btnPrint.addEventListener('click', () => window.print());

  // Generate once on load
  buildPack();
});
</script>

</body>
</html>
